

vmware hostonly network

passwd
rc-service sshd start
ip -4 addr

wipefs -a /dev/sda
parted /dev/sda --script mklabel msdos 
parted /dev/sda --script -- mkpart primary 4MB -1
lsblk

mkfs.ext4 -F /dev/sda1

mount /dev/sda1 /mnt/gentoo

cd /mnt/gentoo  #开两个ssh，都进入/mnt/gentoo，第二个用来查看文件与包

复制stage3，portage，gnome 到/mnt/gentoo

tar xvf stage3-amd64-20190901T214501Z.tar.xz

# dns，网关
cp /etc/resolv.conf etc

# rsync时地址
mkdir --parents /mnt/gentoo/etc/portage/repos.conf
cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf

mount -t proc none proc
mount --rbind /sys sys
mount --make-rslave sys
mount --rbind /dev dev
mount --make-rslave dev

chroot . /bin/bash
source /etc/profile

tar xf portage-20190901.tar.xz
rm -rf /var/db/repos/gentoo
mv portage /var/db/repos/gentoo

mv gnome/* /var/cache/distfiles/
rm -rf gnome
ls /var/cache/distfiles/

ls /var/cache/distfiles/ > /var/cache/distfiles/pkg.txt # 记录现在的包，对比，安装完是否有下载

nano /etc/portage/make.conf
COMMON_FLAGS="-O2 -march=native -pipe"
MAKEOPTS="-j2"
GENTOO_MIRRORS="https://mirrors.163.com/gentoo/"
INPUT_DEVICES="libinput keyboard mouse"
VIDEO_CARDS="vmware"

passwd

useradd -g users -G wheel,portage,audio,video,usb,cdrom -m qianggetaba
passwd qianggetaba

echo 'LANG="en_US.utf8"
LC_COLLATE="C"' > /etc/env.d/02locale

echo 'Asia/Shanghai' > /etc/timezone
emerge --config sys-libs/timezone-data # ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

echo 'en_US.UTF-8 UTF-8' >>/etc/locale.gen
echo 'zh_CN.UTF-8 UTF-8' >>/etc/locale.gen
locale-gen

nano /etc/conf.d/hostname

nano /etc/hosts
127.0.0.1     mygentoo.homenetwork mygentoo localhost

dd if=/dev/zero of=/swapfile count=8M
mkswap /swapfile
chmod 0600 /swapfile
swapon /swapfile # swapon -a will load in fstab
free -h

nano /etc/fstab
/dev/sda1		/		ext4		noatime		0 1
/swapfile	        none	        swap	        sw,loop	        0 0

ln -sf /proc/self/mounts /etc/mtab  # for systemd

eselect profile list # see default with * at the end
eselect profile set default/linux/amd64/17.1/desktop/gnome/systemd

emerge --ask --verbose --update --deep --newuse @world  # 271 pkgs, -j4,2g ram,4g swap,16:00--18:15
emerge --update --newuse --deep --with-bdeps=y @world
emerge --depclean

emerge --ask --verbose --autounmask-write sys-kernel/gentoo-sources sys-kernel/genkernel-next sys-kernel/linux-firmware sys-boot/grub net-misc/dhcpcd app-portage/gentoolkit  # 20:38--21:30
emerge --ask --verbose --autounmask-write x11-base/xorg-server # 21:40--21:54
emerge --ask --verbose --autounmask-write gnome-base/gnome-light # 10:17--  , compile webkit each job need 2g ram, but -j8 will fail

emerge --update --newuse --deep --with-bdeps=y @world
emerge --depclean

nano /etc/genkernel.conf
MAKEOPTS="j2" UDEV="yes"

genkernel --menuconfig all
Gentoo Linux --->
        Support for init systems, system and service managers --->
                [*] systemd
Processor type and features  --->
    [*] EFI runtime service support 
    [*]   EFI stub support
Firmware Drivers  --->
    EFI (Extensible Firmware Interface) Support  --->
        <*> EFI Variable Support via sysfs

nano /etc/default/grub
GRUB_CMDLINE_LINUX="rootfstype=ext4 init=/lib/systemd/systemd"
grub-install --target=i386-pc /dev/sda
grub-mkconfig -o /boot/grub/grub.cfg

exit
cd ~
umount -R /mnt/gentoo
reboot


after reboot
root login
systemctl start gdm
in gnome desktop, systemctl start NetwokManager,install sudo, lbzip2

tar --use-compress-program=lbzip2 -cvf /backup.tar.bz2 --exclude=/backup.tar.bz2 --one-file-system /  # system full backup
tar -xf etc-backup.tar.bz2 -C /


emerge --ask lbzip2
EXTRA_ECONF="--with-bzip2=lbzip2" emerge -avD tar
tar --help | grep -- --bzip2 |grep lbzip2

tar --ignore-failed-read -cvjf /backup.tar.bz2 --exclude=/backup.tar.bz2 --one-file-system /

